name: "Main workflow"

on:
  workflow_dispatch:

jobs:
  reusables:
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix:
        one:
        - 1
        - 2
        - 3
        - 4
    uses: ./.github/workflows/reusable.yaml
    with:
      one: ${{ matrix.one }}

  check_outputs:
    needs: [reusables]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Dump outputs context
        env:
          OUTPUTS_CONTEXT: ${{ toJSON(needs.reusables.outputs) }}
        run: |
          echo "Outputs context is:"
          echo "$OUTPUTS_CONTEXT"
      - name: Iterate over matrix outputs (if outputs object is a matrix)
        env:
          OUTPUTS_CONTEXT: ${{ toJSON(needs.reusables.outputs) }}
        run: |
          # This assumes the output is an object of objects, as per documentation
          # If the dump step shows a single object, this step might fail or produce no output
          echo "$OUTPUTS_CONTEXT" | jq -r 'to_entries[] | "Matrix key \(.key): cleanup_result is \(.value.cleanup_result)"'
